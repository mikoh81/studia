<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset = utf-8" /></head>
<body>
    <form id="addForm" onsubmit="return add(event)">
	  <input type id="idInput" name="id" type="number" style="visibility: hidden" />
      </br><label for="name">Name:</label><input name="name" type="text" id="name"><br />
      <label for="lastName">Last name:</label><input name="lastName" id="lastName" type="text" required ><br />
      <label for="age">Age:</label><input name="age" type="number" id="age"  required><br />
      <label for="email">Email:</label><input type="email" id="email" name="email" placeholder="example@gmail.com" required><br/>
      <label for="pesel">Pesel:</label><input name="pesel" id="pesel" type="text" pattern="^[[0-9]{11}$" required /><br />
      <label for="address">Address:</label><input name="address" id="adress" type="text" required /><br />
      <label for="tel">Phone number:</label><input type="tel" id="tel" name="tel" pattern="[0-9]{9}" placeholder="xxxxxxxxx" required>
      <br />
      <input id="submitBtn" type="submit" value="Add entry" />
    </form>
    <button onclick="return insertRandomCell()">Insert Random Cell</button>
	<button id="editBtn" onclick="editData(event)" disabled>Edit entry</button>
    <button id="cancelBtn" onclick="cancelEdit(event)" disabled>Cancel Edit</button>

    </br><div id="searchFiled"><input id="searchBar" name="search" type="text" placeholder="Search..." />
      <button onclick="return search(event)">Search</button>
	
 <div id="tableDiv"></div>
<script type="text/javascript">
 <script type="text/javascript">
      //prefixes of implementation that we want to test
      window.indexedDB =
        window.indexedDB ||
        window.mozIndexedDB ||
        window.webkitIndexedDB ||
        window.msIndexedDB;

      //prefixes of window.IDB objects
      window.IDBTransaction =
        window.IDBTransaction ||
        window.webkitIDBTransaction ||
        window.msIDBTransaction;
      window.IDBKeyRange =
        window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

      if (!window.indexedDB) {
        window.alert(
          "Your browser doesn't support a stable version of IndexedDB."
        );
      }

      const clientData = [
        {
          name: "Karol",
          lastName: "Nowik",
          age: "22",
          email: "karol@gmail.com",
          pesel: "12345678901",
          address: "Zachodnia 1",
          phoneNumber: "500500200",
        },
        {
          name: "Marcin",
          lastName: "Kowalski",
          age: "23",
          email: "marcin@gmail.com",
          pesel: "12345678902",
          address: "Zachodnia 2",
          phoneNumber: "500400200",
        },
      ];

      const NAMES = [
        "Jan",
        "Marcin",
        "Stefan",
        "Karol",
        "Mikolaj",
        "Franek",
        "Bartek",
        "Olek",
        "Juliusz",
        "Adam",
      ];
      const SURNAMES = [
        "Kowalski",
        "Kowalczyk",
        "Kwiatkowski",
        "Bartczak",
        "Stefanowski",
        "Piłsudzki",
        "Dmowski",
      ];
      const ADDRESSES = [
        "Polna",
        "Leśna",
        "Słoneczna",
        "Krótka",
        "Szkolna",
        "Ogrodowa",
        "Lipowa",
		"Łąkowa",
      ];

      let db;
      let request = window.indexedDB.open("newDatabase", 1);

      request.onerror = function (event) {
        console.log("error: The database is opened failed");
      };

      request.onsuccess = function (event) {
        db = request.result;
        console.log("success: The database " + db + " is opened successfully");
        drawTable();
      };

      request.onupgradeneeded = function (event) {
        var db = event.target.result;
        var objectStore = db.createObjectStore("client", {
          autoIncrement: true,
        });

        objectStore.createIndex("name", "name", { unique: false });
        objectStore.createIndex("lastName", "lastName", { unique: false });
        objectStore.createIndex("age", "age", { unique: false });
        objectStore.createIndex("email", "email", { unique: false });
        objectStore.createIndex("pesel", "pesel", { unique: false });
        objectStore.createIndex("address", "address", { unique: false });
        objectStore.createIndex("phoneNumber", "phoneNumber", {
          unique: false,
        });

        for (var i in clientData) {
          objectStore.add(clientData[i]);
        }
      };

      function add(event) {
        event.preventDefault();

        var formElements = document.getElementById("addForm");

        var request = db
          .transaction(["client"], "readwrite")
          .objectStore("client")
          .add({
            name: formElements[1].value,
            lastName: formElements[2].value,
            age: formElements[3].value,
            email: formElements[4].value,
            pesel: formElements[5].value,
            address: formElements[6].value,
            phoneNumber: formElements[7].value,
          });

        request.onsuccess = function (event) {
          console.log("Client added");
          drawTable();
        };

        request.onerror = function (event) {
          alert(
            "Unable to add data\r\ user with that (email | pesel | phoneNumber) aready exist in your database! Those are the unique fileds"
          );
        };

        return false;
      }

      function search(event) {
        event.preventDefault();

        let searchInputs = document
          .getElementById("searchBar")
          .value.split(" ");

        drawTable(searchInputs);
      }

      document
        .getElementById("searchBar")
        .addEventListener("input", (event) => {
          drawTable(event.target.value.split(" "));
        });

      function remove(id) {
        let request = db
          .transaction(["client"], "readwrite")
          .objectStore("client")
          .delete(id);

        request.onsuccess = function (event) {
          console.log(`Client ${id} removed...`);
          drawTable();
        };
      }

      function editData(event) {
        event.preventDefault();
        let formElements = document.getElementById("addForm");

        console.log(`Editing ${parseInt(formElements[0].value)}`);

        var objectStore = db
          .transaction(["client"], "readwrite")
          .objectStore("client");

        var request = objectStore.get(parseInt(formElements[0].value));
        request.onerror = function (event) {
          // Handle errors!
          console.log(
            "Something went wrong, prob client with that id does not exits"
          );
        };
        request.onsuccess = function (event) {
          // Get the old value that we want to update
          let data = event.target.result;

          let client = {
            name: formElements[1].value,
            lastName: formElements[2].value,
            age: formElements[3].value,
            email: formElements[4].value,
            pesel: formElements[5].value,
            address: formElements[6].value,
            phoneNumber: formElements[7].value,
          };

          console.log(client);

          // Get the old value that we want to update
          let requestUpdate = db
            .transaction(["client"], "readwrite")
            .objectStore("client")
            .put(client, parseInt(formElements[0].value));

          requestUpdate.onsuccess = function (event) {
            console.log("Record updated");
            drawTable();
          };
        };
      }

      function cancelEdit(event) {
        event.preventDefault();
        document.getElementById("editBtn").disabled = true;
        document.getElementById("cancelBtn").disabled = true;
        document.getElementById("submitBtn").disabled = false;
      }

      function fillEditData(id) {
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("editBtn").disabled = false;
        document.getElementById("cancelBtn").disabled = false;

        var objectStore = db
          .transaction(["client"], "readwrite")
          .objectStore("client");

        var request = objectStore.get(id);
        request.onerror = function (event) {
          // Handle errors!
          console.log("Something went wrong");
        };
        request.onsuccess = function (event) {
          // Get the old value that we want to update
          let data = event.target.result;

          document.getElementById("idInput").value = id;
          document.getElementById("nameInput").value = data.name;
          document.getElementById("lastNameInput").value = data.lastName;
          document.getElementById("ageInput").value = data.age;
          document.getElementById("emailInput").value = data.email;
          document.getElementById("peselInput").value = data.pesel;
          document.getElementById("addressInput").value = data.address;
          document.getElementById("phoneNumberInput").value = data.phoneNumber;
        };
      }

      function generateTableHead(table, data) {
        let thead = table.createTHead();
        let row = thead.insertRow();

        // Create id column
        let th = document.createElement("th");
        let text = document.createTextNode("id");
        th.appendChild(text);
        row.appendChild(th);

        for (let key of data) {
          let th = document.createElement("th");
          let text = document.createTextNode(key);
          th.appendChild(text);
          row.appendChild(th);
        }
      }


    </script>
  </body>
</html>

 